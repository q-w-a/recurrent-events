---
title: "Analysis"
author: "Quinn White"
date: "`r Sys.Date()`"
output: 
  html_document:
    code_folding: hide 
    toc: true
knit: (function(input,...) {
  rmarkdown::render(input,output_dir=here::here("output"))})
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)


library(tidyverse)
library(here)
library(lmtp)

theme_c <- function(...){ 
   # font <- "Helvetica"   #assign font family up front
  #  font <- "Arial"
    theme_bw() %+replace%    #replace elements we want to change
    
    theme(
      
      #text elements
      plot.title = element_text(             #title
                 #  family = font,            #set font family
                   size = 11,                #set font size
                   face = 'bold',            #bold typeface
                   hjust = .5,
                   vjust = 3),               
      
      plot.subtitle = element_text(          #subtitle
                #   family = font,            #font family
                   size = 10,
                   hjust = .5,
                   face = 'italic',
                   vjust = 3),               #font size
      
      axis.title = element_text(             #axis titles
                #   family = font,            #font family
                   size = 10),               #font size
      
      axis.text = element_text(              #axis text
                #   family = font,            #axis famuly
                   size = 8),
      strip.text = element_text(color="white", size = 9,
                                margin=unit(c(.1,.1,.1,.1), 'cm')),
      strip.background = element_rect(fill = "#363636"),
      # t, r, b, l
      plot.margin = unit(c(1,.5,.5,.5), "cm")
      ) %+replace%
      theme(...)
   
}


```

We use the `lmtp` R package, which has extensive documentation [here](https://beyondtheate.com/10_R_multivariate.html). Theoretical details are in __. 

```{r}

dat <- readRDS(here("data/sim_dat.RDS")) %>%
  rowwise() %>%
  mutate(Y_sum = sum(c_across(starts_with("Y")), 
                     na.rm = TRUE)) %>%
  ungroup() %>%
  mutate(A0_1 = 0,
         A0_2 = 0)
  


learners <- c(
  "SL.glm",        # logistic regression anchor
  "SL.glmnet",     # lasso / elastic net
  "SL.gam",        # smooth nonlinearities
  "SL.ranger",     # random forest
  "SL.xgboost"     # boosted trees (if installed)
)


treat_names <- dat %>%
  select(contains("A")) %>%
  colnames()

list_treat_names <- map(seq(1, length(treat_names), by=2), ~{
  c(treat_names[.x], treat_names[.x+1])
})


d_no_treat <- function(data, a) {
  d1 <- \(x) 0
  d2 <- \(x) 0

  out <- list(
    d1(data[[a[1]]]),
    d2(data[[a[2]]])
  )
  
  setNames(out, a)
}

L_list <- dat %>%
  select(contains("L")) %>%
  colnames() %>%
  as.list()

model <- lmtp_tmle(data = dat, 
                 trt = list_treat_names, 
                 outcome = "Y_sum", 
                 time_vary = L_list,
                 shift = d_no_treat, 
                 mtp = FALSE,
                 outcome_type = "continuous",
                 learners_trt = learners, 
                 learners_outcome = learners, 
                 folds = 10)



```


